machine:
  environment:
    PATH: $PATH:node_modules/.bin
    EXTERNAL_REGISTRY_BASE_DOMAIN: quay.io/reactiveops
    REPOSITORY_NAME: docker-thrift
    REGISTRY_EMAIL: none
    REGISTRY_USERNAME: AWS

    CI_SHA1: $CIRCLE_SHA1
    CI_BRANCH: $CIRCLE_BRANCH
    CI_BUILD_NUM: $CIRCLE_BUILD_NUM

    DOCKERTAG: docker-thrift

    CLUSTER_NICKNAME_PRODUCTION: production-1.demo.hillghost.com
    CLUSTER_NICKNAME_WORKING: working-1.demo.hillghost.com

  services:
    - docker

dependencies:
  pre:
    - npm install
    - docker login -e "." -u $QUAY_USERNAME -p $QUAY_PASSWORD quay.io
    - docker-pull -f deploy/k8s-scripts.config
    - docker build --rm=false -t ${DOCKERTAG}:latest .

  override:
    - echo "overriding inferred dependencies"

database:
  override:
    - echo "overriding inferred dependencies"

test:
  override:
    - echo "implement some tests"

deployment:
  production:
    branch: master
    commands:
      - docker-push -f deploy/k8s-scripts.config
      # - ensure-kubectl
      # - prepare-kubectl
      # - kubectl config set-context production --user $CLUSTER_NICKNAME_PRODUCTION --cluster $CLUSTER_NICKNAME_PRODUCTION --namespace kube-system
      # - kubectl config use-context production
      # - k8s-deploy -f deploy/production.config
      #
  release:
    tag: /v.*/
    owner: reactiveops
      - git fetch --tags
      - curl -O https://raw.githubusercontent.com/reactiveops/release.sh/v0.0.2/release
      - /bin/bash release
      - docker-push
